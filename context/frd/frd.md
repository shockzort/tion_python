# Functional Requirements Document (FRD) для интеграции бризеров Tion с Яндекс Алисой

## 1. Функциональные требования

### 1.1. Управление устройствами

- **Голосовые команды через Яндекс Алису**:
  - Включение/выключение бризеров по имени (например, "Алиса, включи бризер в гостиной").
  - Установка скорости вентиляции (1-6 уровней).
  - Переключение режимов: "тихий", "турбо", "ночной", "проветривание".
  - Управление подогревом: включение/выключение, установка температуры (10-30°C).
  - Запрос статуса: текущая температура, уровень CO₂, влажность, режим работы.
- **Групповое управление**:
  - Команды для всех устройств (например, "выключи все бризеры").
  - Создание групп устройств через веб-интерфейс.
- **Интеграция с датчиками**:
  - Автоматическая корректировка работы бризеров на основе данных:
    - CO₂ > 1000 ppm → активация "турбо"-режима.
    - Температура > 25°C → отключение подогрева.
  - Поддержка сторонних датчиков (через MQTT/HTTP API).

### 1.2. Сценарии автоматизации

- **Настройка триггеров**:
  - По времени (например, "ночной режим с 23:00 до 7:00").
  - По показаниям датчиков (CO₂, температура, влажность).
- **Сохранение сценариев** в БД с возможностью редактирования.

### 1.3. Веб-интерфейс

- **Основные функции**:
  - Автоматизированный поиск, добавление/удаление устройств.
  - Просмотр статуса устройств в реальном времени.
  - Ручное управление бризерами (режимы, скорость, температура).
  - Настройка сценариев автоматизации.
  - Просмотр истории изменений и статистики.
  - Визуализация данных с датчиков за период.
- **Доступ**:
  - Локальный доступ (оффлайн) через браузер.
  - Удаленный доступ через защищенное соединение (HTTPS) с авторизацией.

## 2. Нефункциональные требования

- **Производительность**:
  - Задержка выполнения команд: < 3 сек.
  - Поддержка до 10 одновременных пользователей.
- **Расширяемость**:
  - Возможность дальнейшего расширения функционала - интеграция других устройств умного дома в экосистему (датчики температуры, влажности, протечки, датчики утечки газа и пр.)
- **Совместимость**:
  - ОС: Linux (Debian/Ubuntu/Raspberry Pi OS).
  - Python: версия 3.10+.
  - Браузеры: Chrome, Firefox, Safari.
- **Безопасность**:
  - Шифрование данных аутентификации (AES-256).
  - Регулярное обновление сертификатов TLS.
- **Надежность**:
  - Автоматическое переподключение к устройствам при потере связи.
  - Резервное копирование БД ежедневно.

## 3. Технологический стек

- **Языки и протоколы**:
  - Python (TionAPI, Flask для веб-интерфейса).
  - Bluetooth BLE (библиотека `Bleak`).
  - MQTT для интеграции сторонних датчиков.
- **Базы данных**:
  - SQLite (локальное хранение) / Redis (кеширование).
  - **Схема БД**:
    - Устройства: `id, name, type, mac_address, updated_date`.
    - Пользователи: `id, login, password_hash`.
    - Сценарии: `id, name, trigger_type, trigger_params, action_params`.
- **Интеграция с TionAPI**:
  - Использование методов библиотеки для:
    - Поиска устройств через Bluetooth.
    - Отправки команд (скорость, режим, подогрев).
    - Чтения данных с датчиков.

## 4. Bluetooth-сопряжение

- **Поиск устройств**:
  - Сканирование BLE-устройств с фильтрацией по имени ("Tion_Breezer_*").
  - Сохранение MAC-адресов в БД после первого подключения.
- **Авторизация**:
  - Использование статического PIN-кода (из документации Tion).
  - Кеширование ключей соединения для быстрого переподключения.

## 5. Пользовательский интерфейс

- **Веб-интерфейс**:
  - **Главная страница**: Список устройств с кнопками управления и статусом.
  - **Сценарии**: Форма создания/редактирования с визуальным конструктором.
  - **Настройки**: Разделы для добавления устройств, управления пользователями.
  - **Статистика**: Графики уровня CO₂, температуры за выбранный период (данных с иных датчиков).
- **Мобильная версия**: Адаптивный дизайн для Android-устройств.

## 6. Развертывание

- **Установка**:
  - Использование Docker-контейнеров для изоляции компонентов.
  - Настройка systemd-сервиса для автоматического запуска.
- **Обновление**:
  - Git-репозиторий с CI/CD (автоматическое тестирование и деплой).
- **Безопасность**:
  - Nginx в качестве reverse proxy с HTTPS (Let's Encrypt).
  - Firewall: ограничение доступа к портам 22 (SSH), 443 (HTTPS).
  - Регулярное обновление зависимостей (`pip-audit`).

## 7. Обработка ошибок и логирование

- **Логи**:
  - Хранение в файлах (ротация по размеру/времени).
  - Фиксация ошибок Bluetooth, API, пользовательских действий.
- **Уведомления**:
  - Email-оповещения при критических сбоях (например, потеря связи с сервером).
  - Пуш уведомления через приложение Android.

## 8. UML-диаграммы

### 8.1. Диаграмма классов (основные сущности)

```plantuml
@startuml
class Device {
  - id: int
  - name: str
  - mac_address: str
  - type: str
  + get_status()
  + get_features()
  + send_command()
}

class User {
  - id: int
  - login: str
  - password_hash: str
}

class Scenario {
  - id: int
  - name: str
  - trigger_type: str
  - trigger_params: json
  - action_params: json
}

Device "1" *-- "0..*" Scenario
User "1" -- "0..*" Scenario
@enduml

### 8.2. Диаграмма последовательностей (управление бризером)

```plantuml
@startuml
actor Пользователь
participant "Яндекс Алиса" as Alice
participant "Сервер" as Server
participant "Tion Breezer" as Breezer

Пользователь -> Alice: "Включи бризер в спальне"
Alice -> Server: HTTP POST /command (API)
Server -> Breezer: BLE-команда (включение)
Breezer --> Server: Статус: успех
Server --> Alice: Ответ: "OK"
Alice --> Пользователь: Озвучивание результата
@enduml
